# Steps for publishing project cache

steps:
  - bash: 'mkdir -p $(STAGING_DIRECTORY_UNIX)'
    condition: and(succeeded(), eq(variables['Build.Reason'], 'IndividualCI'))
    displayName: '[Cache][Publish] Create cache directory'

  - bash: export ESY_CACHE_INSTALL_PATH=$( echo $HOME/.esy/3_*/i )
  - bash: echo "Publishing Build Cache From: $ESY_CACHE_INSTALL_PATH"
  - bash: 'cd $ESY__CACHE_INSTALL_PATH && tar -czf $(STAGING_DIRECTORY_UNIX)/esy-cache.tar .'
    workingDirectory: ''
    condition: and(succeeded(), eq(variables['Build.Reason'], 'IndividualCI'))
    displayName: '[Cache][Publish] Tar esy cache directory'

  # - bash: 'cd $(ESY__NPM_ROOT) && tar -czf $(STAGING_DIRECTORY_UNIX)/npm-cache.tar .'
  #   condition: and(succeeded(), eq(variables['Build.SourceBranch'], variables['System.PullRequest.TargetBranch']))
  #   displayName: '[Cache][Publish] Tar npm cache directory'

  - task: PublishBuildArtifacts@1
    displayName: '[Cache][Publish] Upload tarball'
    condition: and(succeeded(), eq(variables['Build.Reason'], 'IndividualCI'))
    # TODO: Include the Build.SourceBranch variable when publishing.
    # TODO: Include the System.PullRequest.TargetBranch variable when pulling.
    #       but these are tricky because we need to convert `/` into `__` or something.
    inputs:
        pathToPublish: '$(STAGING_DIRECTORY)'
        artifactName: 'cache-$(Agent.OS)-install'
        parallel: true
        parallelCount: 8
